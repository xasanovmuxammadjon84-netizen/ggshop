<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GGSHOP | Kompyuter va Aksessuarlar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #000; color: #fff; font-family: 'Inter', sans-serif; }
        .pink-glow:hover { box-shadow: 0 0 15px rgba(255, 0, 127, 0.5); border-color: #ff007f; }
        .bg-dark-card { background-color: #0a0a0a; border: 1px solid #1a1a1a; }
        .btn-pink { background-color: #ff007f; color: white; transition: 0.3s; }
        .btn-pink:hover { background-color: #e60073; transform: scale(1.05); }
    </style>
</head>
<body>

    <nav class="border-b border-gray-900 bg-black sticky top-0 z-50 py-4">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <h1 class="text-3xl font-black tracking-tighter text-white">GG<span class="text-[#ff007f]">SHOP</span></h1>
            
            <div class="hidden md:flex space-x-8 font-medium text-[12px] uppercase tracking-[0.2em]">
                <a href="javascript:void(0)" onclick="showNoStock('Noutbuklar')" class="hover:text-[#ff007f] transition">Noutbuklar</a>
                <a href="javascript:void(0)" onclick="showNoStock('Komplektlar')" class="hover:text-[#ff007f] transition">Komplektlar</a>
                <a href="javascript:void(0)" onclick="showNoStock('Monitorlar')" class="hover:text-[#ff007f] transition">Monitorlar</a>
                <a href="/admin-panel" class="text-gray-500 hover:text-white transition">Admin</a>
            </div>

            <div class="flex items-center space-x-6">
                <div class="relative group">
                    <input type="text" id="searchInput" oninput="searchProducts()" placeholder="Qidirish..." 
                           class="bg-transparent border-b border-gray-800 focus:border-pink-500 outline-none text-xs py-1 px-2 transition-all w-0 group-hover:w-40 md:w-40 opacity-0 group-hover:opacity-100">
                    <i class="fa-solid fa-magnifying-glass cursor-pointer hover:text-[#ff007f]"></i>
                </div>
                
                <div class="relative cursor-pointer" onclick="toggleCart()">
                    <i class="fa-solid fa-cart-shopping text-xl"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-[#ff007f] text-[10px] rounded-full w-4 h-4 flex items-center justify-center font-bold">0</span>
                </div>
            </div>
        </div>
    </nav>

    <header id="banner-container" class="container mx-auto px-4 py-8">
        <div class="relative rounded-2xl overflow-hidden h-[400px] bg-gradient-to-r from-[#2d112b] to-[#7a1b4d]">
            <div class="absolute inset-0 bg-black/20 flex flex-col justify-center p-12">
                <h2 class="text-5xl font-black mb-4 uppercase italic leading-none tracking-tighter">
                    YANGI YIL BILAN<br><span class="text-[#ff007f]">NOUTBUKLAR!</span>
                </h2>
                <p class="text-lg mb-8 text-gray-300">Barcha mahsulotlarga 15-yanvargacha chegirmalar</p>
                <button class="btn-pink w-fit px-10 py-3 rounded-full font-bold uppercase text-[12px] tracking-widest">Batafsil</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-12">
        <h3 id="section-title" class="text-xl font-bold mb-10 uppercase tracking-[0.2em] border-l-4 border-[#ff007f] pl-4">Yangi mahsulotlar</h3>
        
        <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6">
            </div>
    </main>

    <div id="cart-modal" class="fixed inset-0 bg-black/90 hidden z-[100] flex justify-end">
        <div class="bg-dark-card w-full max-w-md h-full p-8 border-l border-gray-800 shadow-2xl">
            <div class="flex justify-between items-center mb-10">
                <h2 class="text-2xl font-black uppercase tracking-tighter">Savatcha</h2>
                <button onclick="toggleCart()" class="text-3xl hover:text-[#ff007f] transition">&times;</button>
            </div>
            <div id="cart-items" class="space-y-4 overflow-y-auto max-h-[65%] pr-2"></div>
            <div class="absolute bottom-8 left-8 right-8 bg-black p-6 border-t border-gray-900">
                <div class="flex justify-between text-xl font-black mb-6">
                    <span>JAMI:</span>
                    <span id="total-price" class="text-[#ff007f]">0 LZS</span>
                </div>
                <button onclick="processOrder()" class="btn-pink w-full py-4 rounded-xl font-black uppercase tracking-widest shadow-lg">Rasmiylashtirish</button>
            </div>
        </div>
    </div>

    <script>
        const API_PRODUCTS = "/api/products/products/";
        const API_PROMOS = "/api/orders/promos/";
        let cart = [];

        // 1. Qidiruv natijasi sarlavhasini o'zgartirish mantiqi
        async function searchProducts() {
            const query = document.getElementById('searchInput').value;
            const titleElement = document.getElementById('section-title');
            
            if (query.length > 0) {
                titleElement.innerText = `"${query}" bo'yicha qidiruv natijalari:`;
            } else {
                titleElement.innerText = "Yangi mahsulotlar";
            }

            try {
                const res = await fetch(`${API_PRODUCTS}?search=${query}`);
                const data = await res.json();
                renderProducts(data.results || data);
            } catch (e) { console.error("Qidiruvda xatolik"); }
        }

        // 2. Menyu tugmalari uchun ogohlantirish
        function showNoStock(categoryName) {
            alert(`${categoryName} hozirda nalichkada yo'q!`);
        }

        // 3. Rasmiylashtirish: Login va Savat tekshiruvi
        function processOrder() {
            // Django template variable orqali autentifikatsiyani tekshirish
            const isAuthenticated = "{{ request.user.is_authenticated }}" === "True";

            if (cart.length === 0) {
                alert("Savatchangiz bo'sh! Avval mahsulot qo'shing.");
                return;
            }

            if (!isAuthenticated) {
                alert("Rasmiylashtirish uchun avval ro'yxatdan o'ting!");
                window.location.href = "/admin/login/"; 
            } else {
                alert("Buyurtmangiz rasmiylashtirildi! Tez orada operator bog'lanadi.");
                cart = [];
                updateCart();
                toggleCart();
            }
        }

        // Mahsulotlarni yuklash va ko'rsatish
        async function loadProducts() {
            try {
                const res = await fetch(API_PRODUCTS);
                const products = await res.json();
                renderProducts(products.results || products);
            } catch (e) { console.error("Mahsulotlar yuklanmadi"); }
        }

        function renderProducts(products) {
            const grid = document.getElementById('product-grid');
            if (!products || products.length === 0) {
                grid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">Hech narsa topilmadi</p>';
                return;
            }
            grid.innerHTML = products.map(p => `
                <div class="bg-dark-card rounded-xl p-5 pink-glow transition-all duration-500 flex flex-col h-full group">
                    <div class="overflow-hidden rounded-lg mb-4 bg-black h-40 flex items-center justify-center">
                        <img src="${p.image}" class="max-h-full max-w-full object-contain group-hover:scale-110 transition duration-500">
                    </div>
                    <h4 class="text-[10px] text-gray-500 mb-1 uppercase tracking-widest">${p.category_name || 'Kompyuter'}</h4>
                    <h3 class="font-bold text-sm mb-4 flex-grow line-clamp-2 uppercase tracking-tight text-gray-200">${p.name}</h3>
                    <div class="flex items-center mb-4 text-[10px] text-yellow-500 space-x-1">
                        <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
                    </div>
                    <div class="flex flex-col mb-4">
                        <span class="text-[10px] text-gray-600 line-through uppercase">Chegirma mavjud</span>
                        <span class="text-lg font-black text-[#ff007f]">${parseFloat(p.price).toLocaleString()} LZS</span>
                    </div>
                    <button onclick="addToCart(${p.id}, '${p.name}', ${p.price})" class="btn-pink py-2.5 rounded-lg font-black text-[10px] uppercase tracking-widest flex items-center justify-center">
                        <i class="fa-solid fa-cart-plus mr-2 text-xs"></i> Savatga qo'shish
                    </button>
                </div>
            `).join('');
        }

        function addToCart(id, name, price) {
            cart.push({id, name, price});
            updateCart();
        }

        function updateCart() {
            document.getElementById('cart-count').innerText = cart.length;
            const items = document.getElementById('cart-items');
            items.innerHTML = cart.map((item, i) => `
                <div class="flex justify-between items-center bg-[#050505] p-4 rounded-lg border border-gray-900">
                    <div class="pr-2"><p class="text-[11px] font-bold uppercase tracking-tight">${item.name}</p></div>
                    <div class="text-right shrink-0">
                        <p class="text-[#ff007f] font-black text-xs">${item.price.toLocaleString()} LZS</p>
                        <button onclick="removeItem(${i})" class="text-[9px] text-gray-600 hover:text-white uppercase mt-1">O'chirish</button>
                    </div>
                </div>
            `).join('');
            const total = cart.reduce((sum, item) => sum + parseFloat(item.price), 0);
            document.getElementById('total-price').innerText = total.toLocaleString() + " LZS";
        }

        function removeItem(i) { cart.splice(i, 1); updateCart(); }
        function toggleCart() { document.getElementById('cart-modal').classList.toggle('hidden'); }
        
        window.onload = loadProducts;
    </script>
</body>
</html>